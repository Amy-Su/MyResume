<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <script src="../js/jquery-2.2.3.min.js"></script>
    <meta charset="utf-8" />
    <style>
        .GameWindow {
            position: relative;
            padding: 0;
            margin: 0 auto;
            width: 640px;
            margin-top: 100px;
        }

            .GameWindow .Map {
                position: relative;
                margin: 0 auto;
                width: 640px;
                margin-top: 100px;
            }
    </style>
</head>
<body>
    <div class="GameWindow">
        <div class="Person"></div>
        <div class="Map"></div>
    </div>
</body>
</html>
<script>
    $(function () {
        var GameMap = [
            {
                //0是空的地图
                //1是板砖
                //3是目标点
                state: [
                  [0, 0, 1, 1, 1, 0, 0, 0, 0],
                  [0, 1, 1, 3, 3, 1, 0, 0, 0],
                  [0, 1, 0, 0, 0, 0, 1, 0, 0],
                  [0, 1, 0, 0, 0, 0, 1, 0, 0],
                  [0, 1, 1, 1, 1, 1, 1, 0, 0]
                ],
                person: { x: 2, y: 2 },
                box: [{ x: 3, y: 2 }, { x: 4, y: 2 }]
            },
            //第二关
            {
                //0是空的地图
                //1是板砖
                //3是目标点
                state: [
                  [0, 1, 1, 1, 1, 1, 0, 0],
                  [0, 1, 0, 0, 1, 1, 1, 0],
                  [0, 1, 0, 0, 0, 0, 1, 0],
                  [1, 1, 1, 0, 1, 0, 1, 1],
                  [1, 3, 1, 0, 1, 0, 0, 1],
                  [1, 3, 0, 0, 0, 1, 0, 1],
                  [1, 3, 0, 0, 0, 0, 0, 1],
                  [1, 1, 1, 1, 1, 1, 1, 1]
                ],
                person: { x: 2, y: 2 },
                box: [{ x: 3, y: 2 }, { x: 2, y: 5 }, { x: 5, y: 6 }]
                /*
                box : [
                  {x:3, y : 1},
                  {x:4, y : 1},
                  {x:4, y : 2},
                  {x:5, y : 5}
                ]
                */
            },
            //第三关
            {
                //0是空的地图
                //1是板砖
                //3是目标点
                state: [
                  [0, 0, 0, 1, 1, 1, 1, 1, 1, 0],
                  [0, 1, 1, 1, 0, 0, 0, 0, 1, 0],
                  [1, 1, 3, 0, 0, 1, 1, 0, 1, 1],
                  [1, 3, 3, 0, 0, 0, 0, 0, 0, 1],
                  [1, 3, 3, 0, 0, 0, 0, 0, 1, 1],
                  [1, 1, 1, 1, 1, 1, 0, 0, 1, 0],
                  [0, 0, 0, 0, 0, 1, 1, 1, 1, 0]
                ],
                person: { x: 8, y: 3 },
                box: [{ x: 4, y: 2 }, { x: 3, y: 3 }, { x: 4, y: 4 }, { x: 5, y: 3 }, { x: 6, y: 4 }]
            },
            //第四关
            {
                //0是空的地图
                //1是板砖
                //3是目标点
                state: [
                  [0, 1, 1, 1, 1, 1, 1, 1, 0, 0],
                  [0, 1, 0, 0, 0, 0, 0, 1, 1, 1],
                  [1, 1, 0, 1, 1, 1, 0, 0, 0, 1],
                  [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                  [1, 0, 3, 3, 1, 0, 0, 0, 1, 1],
                  [1, 1, 3, 3, 1, 0, 0, 0, 1, 0],
                  [0, 1, 1, 1, 1, 1, 1, 1, 1, 0]
                ],
                person: { x: 2, y: 3 },
                box: [{ x: 2, y: 2 }, { x: 4, y: 3 }, { x: 6, y: 4 }, { x: 7, y: 3 }, { x: 6, y: 4 }]
            },
            //第五关
            {
                //0是空的地图
                //1是板砖
                //3是目标点
                state: [
                  [0, 0, 1, 1, 1, 1, 0, 0],
                  [0, 0, 1, 3, 3, 1, 0, 0],
                  [0, 1, 1, 0, 3, 1, 1, 0],
                  [0, 1, 0, 0, 0, 3, 1, 0],
                  [1, 1, 0, 0, 0, 0, 1, 1],
                  [1, 0, 0, 1, 0, 0, 0, 1],
                  [1, 0, 0, 0, 0, 0, 0, 1],
                  [1, 1, 1, 1, 1, 1, 1, 1]
                ],
                person: { x: 4, y: 6 },
                box: [{ x: 4, y: 3 }, { x: 3, y: 4 }, { x: 4, y: 5 }, { x: 5, y: 5 }]
                /*
                 box : [
                 {x:3, y : 1},
                 {x:4, y : 1},
                 {x:4, y : 2},
                 {x:5, y : 5}
                 ]
                 */
            },
            //第六关
            {
                //0是空的地图
                //1是板砖
                //3是目标点
                state: [
                  [0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0],
                  [0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0],
                  [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0],
                  [1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 1, 0],
                  [3, 3, 3, 1, 1, 0, 0, 0, 0, 0, 1, 1],
                  [3, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 1],
                  [3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                  [3, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 1],
                  [3, 3, 3, 1, 1, 1, 0, 1, 0, 0, 1, 1],
                  [1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0],
                  [0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0],
                  [0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0]
                ],
                person: { x: 5, y: 10 },
                box: [
                  { x: 5, y: 6 },
                  { x: 6, y: 3 },
                  { x: 6, y: 5 },
                  { x: 6, y: 7 },
                  { x: 6, y: 9 },
                  { x: 7, y: 2 },
                  { x: 8, y: 2 },
                  { x: 9, y: 6 }
                ]
            }]
        var clearFlag = false;
        var State = prompt("请输入关卡", 1) - 1;
        if (State > GameMap.length - 1)
            State = GameMap.length - 1;
        Init.Map(GameMap, State);
        Init.Person(GameMap, State);
        Init.Box(GameMap, State);
        $("body").keydown(function (event) {
            var Keycode = event.keyCode;
            if (Keycode >= 37 && Keycode <= 40) {
                Control.Move(GameMap, State, Keycode);
                clearFlag = Control.IsClear(GameMap, State, clearFlag);
                if (clearFlag) {
                    alert("恭喜您通关！");
                    $(".GameWindow>div:gt(1)").remove();
                    $(".Map").empty();
                    State += 1;
                    if (State > GameMap.length - 1)
                        State = GameMap.length - 1;
                    Init.Map(GameMap, State);
                    Init.Person(GameMap, State);
                    Init.Box(GameMap, State);
                    clearFlag = !clearFlag;
                }
            }
        })
    })
    var Init = {
        Map: function map(GameMap, State) {
            for (var i = 0; i < GameMap[State].state.length; i++) {
                $(".Map").append("<div></div>");
                for (var j = 0; j < GameMap[State].state[i].length; j++) {
                    var row = $(".Map>div").eq(i);
                    row.append("<div></div>");
                    var block = row.children().eq(j);
                    block.css(
                        {
                            "width": "32px",
                            "height": "32px",
                            "position": "absolute",
                            "left": j * 32 + "px",
                            "top": i * 32 + "px"
                        });
                    switch (GameMap[State].state[i][j]) {
                        case 1:
                            block.css("background", "url('brick.png')");
                            break;
                        case 3:
                            block.css("background", "url('place.png')");
                            break;
                        default:
                            break;
                    }
                }
            }
        },
        Person: function person(GameMap, State) {
            var Person = $(".Person");
            Person.css(
                {
                    "position": "absolute",
                    "width": "32px",
                    "height": "32px",
                    "z-index": "2",
                    "background": "url('snail.png')",
                    "left": GameMap[State].person.x * 32,
                    "top": GameMap[State].person.y * 32
                });
        },
        Box: function box(GameMap, State) {
            for (var i = 0; i < GameMap[State].box.length; i++) {
                $(".GameWindow").append("<div></div>");
                $(".GameWindow>div").eq(i + 2).css(
                    {
                        "position": "absolute",
                        "width": "32px",
                        "height": "32px",
                        "z-index": "1",
                        "background": "url('case.png')",
                        "left": GameMap[State].box[i].x * 32,
                        "top": GameMap[State].box[i].y * 32
                    });
            }
        }
    }
    var Control = {
        Move: function move(GameMap, State, Keycode) {
            var map = {
                x: GameMap[State].state[0].length - 1,
                y: GameMap[State].state.length - 1
            }
            var pushBox = false;
            var BoxNum;
            var isCrash = false;
            switch (Keycode) {
                case 37:
                    var move_place = {
                        x: GameMap[State].person.x - 1 < 0 ? 0 : GameMap[State].person.x - 1,
                        y: GameMap[State].person.y
                    };
                    for (var i = 0; i < GameMap[State].box.length; i++) {
                        if (GameMap[State].box[i].x == move_place.x && GameMap[State].box[i].y == move_place.y) {
                            pushBox = true;
                            BoxNum = i;
                            break;
                        }
                    }
                    if (pushBox) {
                        var box_moved = {
                            x: GameMap[State].box[BoxNum].x - 1 < 0 ? 0 : GameMap[State].box[BoxNum].x - 1,
                            y: GameMap[State].person.y
                        };
                        for (var i = 0; i < GameMap[State].box.length; i++) {
                            if (GameMap[State].box[i].x == box_moved.x && GameMap[State].box[i].y == box_moved.y) {
                                isCrash = true;
                                break;
                            }
                        }
                        if(GameMap[State].state[box_moved.y][box_moved.x] != 1 && !isCrash) {
                            GameMap[State].box[BoxNum].x = box_moved.x;
                            GameMap[State].person.x = move_place.x;
                            Init.Box(GameMap, State);
                            Init.Person(GameMap, State);
                        }
                    }
                    else if (GameMap[State].state[move_place.y][move_place.x] != 1) {
                        GameMap[State].person.x = move_place.x;
                        Init.Person(GameMap, State);
                    }
                    break;
                case 39:
                    var move_place = {
                        x: GameMap[State].person.x + 1 > map.x ? map.x : GameMap[State].person.x + 1,
                        y: GameMap[State].person.y
                    };
                    for (var i = 0; i < GameMap[State].box.length; i++) {
                        if (GameMap[State].box[i].x == move_place.x && GameMap[State].box[i].y == move_place.y) {
                            pushBox = true;
                            BoxNum = i;
                            break;
                        }
                    }
                    if (pushBox) {
                        var box_moved = {
                            x: GameMap[State].box[BoxNum].x + 1 > map.x ? map.x : GameMap[State].box[BoxNum].x + 1,
                            y: GameMap[State].person.y
                        };
                        for (var i = 0; i < GameMap[State].box.length; i++) {
                            if (GameMap[State].box[i].x == box_moved.x && GameMap[State].box[i].y == box_moved.y) {
                                isCrash = true;
                                break;
                            }
                        }
                        if (GameMap[State].state[box_moved.y][box_moved.x] != 1 && !isCrash) {
                            GameMap[State].box[BoxNum].x = box_moved.x;
                            GameMap[State].person.x = move_place.x;
                            Init.Box(GameMap, State);
                            Init.Person(GameMap, State);
                        }
                    }
                    else if (GameMap[State].state[move_place.y][move_place.x] != 1) {
                        GameMap[State].person.x = move_place.x;
                        Init.Person(GameMap, State);
                    }
                    break;
                case 38:
                    var move_place = {
                        x: GameMap[State].person.x,
                        y: GameMap[State].person.y - 1 < 0 ? 0 : GameMap[State].person.y - 1
                    };
                    for (var i = 0; i < GameMap[State].box.length; i++) {
                        if (GameMap[State].box[i].x == move_place.x && GameMap[State].box[i].y == move_place.y) {
                            pushBox = true;
                            BoxNum = i;
                            break;
                        }
                    }
                    if (pushBox) {
                        var box_moved = {
                            x: GameMap[State].box[BoxNum].x,
                            y: GameMap[State].person.y - 1 < 0 ? 0 : GameMap[State].box[BoxNum].y - 1
                        };
                        for (var i = 0; i < GameMap[State].box.length; i++) {
                            if (GameMap[State].box[i].x == box_moved.x && GameMap[State].box[i].y == box_moved.y) {
                                isCrash = true;
                                break;
                            }
                        }
                        if (GameMap[State].state[box_moved.y][box_moved.x] != 1 && !isCrash) {
                            GameMap[State].box[BoxNum].y = box_moved.y;
                            GameMap[State].person.y = move_place.y;
                            Init.Box(GameMap, State);
                            Init.Person(GameMap, State);
                        }
                    }
                    else if (GameMap[State].state[move_place.y][move_place.x] != 1) {
                        GameMap[State].person.y = move_place.y;
                        Init.Person(GameMap, State);
                    }
                    break;
                case 40:
                    var move_place = {
                        x: GameMap[State].person.x,
                        y: GameMap[State].person.y + 1 > map.y ? map.y : GameMap[State].person.y + 1
                    };
                    for (var i = 0; i < GameMap[State].box.length; i++) {
                        if (GameMap[State].box[i].x == move_place.x && GameMap[State].box[i].y == move_place.y) {
                            pushBox = true;
                            BoxNum = i;
                            break;
                        }
                    }
                    if (pushBox) {
                        var box_moved = {
                            x: GameMap[State].box[BoxNum].x,
                            y: GameMap[State].person.y + 1 > map.y ? map.y : GameMap[State].box[BoxNum].y + 1
                        };
                        for (var i = 0; i < GameMap[State].box.length; i++) {
                            if (GameMap[State].box[i].x == box_moved.x && GameMap[State].box[i].y == box_moved.y) {
                                isCrash = true;
                                break;
                            }
                        }
                        if (GameMap[State].state[box_moved.y][box_moved.x] != 1 && !isCrash) {
                            GameMap[State].box[BoxNum].y = box_moved.y;
                            GameMap[State].person.y = move_place.y;
                            Init.Box(GameMap, State);
                            Init.Person(GameMap, State);
                        }
                    }
                    else if (GameMap[State].state[move_place.y][move_place.x] != 1) {
                        GameMap[State].person.y = move_place.y;
                        Init.Person(GameMap, State);
                    }
                    break;
            }
        },
        IsClear: function isClear(GameMap, State, clearFlag) {
            var truePlace = 0;
            for (var i = 0; i < GameMap[State].box.length; i++) {
                if (GameMap[State].state[GameMap[State].box[i].y][GameMap[State].box[i].x] == 3)
                    truePlace++;
            }
            if (truePlace == GameMap[State].box.length)
                clearFlag = !clearFlag;
            return clearFlag;
        }
    }
</script>
